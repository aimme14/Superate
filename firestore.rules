rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Funci√≥n auxiliar para verificar si el usuario est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Funci√≥n auxiliar para verificar si la instituci√≥n est√° activa
    function isInstitutionActive(institutionId) {
      return exists(/databases/$(database)/documents/superate/auth/institutions/$(institutionId)) &&
             get(/databases/$(database)/documents/superate/auth/institutions/$(institutionId)).data.isActive == true;
    }
    
    // Funci√≥n auxiliar para verificar si el usuario est√° activo en nueva estructura jer√°rquica
    // Busca en todas las posibles ubicaciones por rol
    function isUserActiveInNewStructure(institutionId, role) {
      return isAuthenticated() && 
        (
          (role == 'rector' && exists(/databases/$(database)/documents/superate/auth/institutions/$(institutionId)/rectores/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/superate/auth/institutions/$(institutionId)/rectores/$(request.auth.uid)).data.isActive == true) ||
          (role == 'principal' && exists(/databases/$(database)/documents/superate/auth/institutions/$(institutionId)/coordinadores/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/superate/auth/institutions/$(institutionId)/coordinadores/$(request.auth.uid)).data.isActive == true) ||
          (role == 'teacher' && exists(/databases/$(database)/documents/superate/auth/institutions/$(institutionId)/profesores/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/superate/auth/institutions/$(institutionId)/profesores/$(request.auth.uid)).data.isActive == true) ||
          (role == 'student' && exists(/databases/$(database)/documents/superate/auth/institutions/$(institutionId)/estudiantes/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/superate/auth/institutions/$(institutionId)/estudiantes/$(request.auth.uid)).data.isActive == true)
        );
    }
    
    // Funci√≥n auxiliar para verificar si el usuario est√° activo
    // Para admin, busca en estructura antigua (solo admin queda ah√≠)
    // Para otros usuarios, busca en nueva estructura
    function isUserActive() {
      return isAuthenticated() && 
        (
          // Admin en estructura antigua
          (exists(/databases/$(database)/documents/superate/auth/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/superate/auth/users/$(request.auth.uid)).data.isActive == true &&
           get(/databases/$(database)/documents/superate/auth/users/$(request.auth.uid)).data.role == 'admin')
        );
    }
    
    // Funci√≥n auxiliar para verificar si la instituci√≥n del usuario est√° activa
    // Para admin, siempre permitir (no tiene instituci√≥n)
    function isUserInstitutionActive() {
      return isAuthenticated() && 
        (
          // Admin no tiene instituci√≥n, siempre permitir
          (exists(/databases/$(database)/documents/superate/auth/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/superate/auth/users/$(request.auth.uid)).data.role == 'admin') ||
          // Para otros usuarios, la validaci√≥n se hace en las reglas espec√≠ficas de cada colecci√≥n
          true
        );
    }
    
    // Funci√≥n auxiliar para verificar si el usuario puede acceder (activo y su instituci√≥n activa)
    function canAccess() {
      return isUserActive() && isUserInstitutionActive();
    }
    
    // Funci√≥n auxiliar para verificar si el usuario es administrador
    // Admin solo existe en estructura antigua
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/superate/auth/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/superate/auth/users/$(request.auth.uid)).data.isActive == true &&
        get(/databases/$(database)/documents/superate/auth/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // La colecci√≥n de usuarios antigua ha sido eliminada completamente
    // Todos los usuarios ahora est√°n en la nueva estructura jer√°rquica por instituci√≥n y rol
    
    // NUEVA ESTRUCTURA JER√ˇRQUICA: Rectores
    match /superate/auth/institutions/{institutionId}/rectores/{rectorId} {
      // Los rectores activos pueden leer su propia informaci√≥n
      allow read: if canAccess() && request.auth.uid == rectorId;
      
      // Solo admins activos pueden leer informaci√≥n de otros rectores
      allow read: if isAdmin();
      
      // Los rectores activos pueden actualizar su propia informaci√≥n (campos limitados)
      allow update: if canAccess() && 
        request.auth.uid == rectorId &&
        request.resource.data.role == 'rector' &&
        request.resource.data.isActive == resource.data.isActive;
      
      // Solo admins activos pueden crear, actualizar o eliminar rectores
      allow create: if isAdmin() &&
        request.resource.data.isActive != null &&
        request.resource.data.role == 'rector';
      
      allow update: if isAdmin() &&
        request.resource.data.role == 'rector' &&
        (request.resource.data.isActive == true || request.resource.data.isActive == false);
      
      allow delete: if isAdmin();
    }
    
    // NUEVA ESTRUCTURA JER√ˇRQUICA: Coordinadores
    match /superate/auth/institutions/{institutionId}/coordinadores/{coordinadorId} {
      // Los coordinadores activos pueden leer su propia informaci√≥n
      allow read: if canAccess() && request.auth.uid == coordinadorId;
      
      // Solo admins activos pueden leer informaci√≥n de otros coordinadores
      allow read: if isAdmin();
      
      // Los coordinadores activos pueden actualizar su propia informaci√≥n (campos limitados)
      allow update: if canAccess() && 
        request.auth.uid == coordinadorId &&
        request.resource.data.role == 'principal' &&
        request.resource.data.isActive == resource.data.isActive;
      
      // Solo admins activos pueden crear, actualizar o eliminar coordinadores
      allow create: if isAdmin() &&
        request.resource.data.isActive != null &&
        request.resource.data.role == 'principal';
      
      allow update: if isAdmin() &&
        request.resource.data.role == 'principal' &&
        (request.resource.data.isActive == true || request.resource.data.isActive == false);
      
      allow delete: if isAdmin();
    }
    
    // NUEVA ESTRUCTURA JER√ˇRQUICA: Profesores
    match /superate/auth/institutions/{institutionId}/profesores/{profesorId} {
      // Los profesores activos pueden leer su propia informaci√≥n
      allow read: if canAccess() && request.auth.uid == profesorId;
      
      // Solo admins activos pueden leer informaci√≥n de otros profesores
      allow read: if isAdmin();
      
      // Los profesores activos pueden actualizar su propia informaci√≥n (campos limitados)
      allow update: if canAccess() && 
        request.auth.uid == profesorId &&
        request.resource.data.role == 'teacher' &&
        request.resource.data.isActive == resource.data.isActive;
      
      // Solo admins activos pueden crear, actualizar o eliminar profesores
      allow create: if isAdmin() &&
        request.resource.data.isActive != null &&
        request.resource.data.role == 'teacher';
      
      allow update: if isAdmin() &&
        request.resource.data.role == 'teacher' &&
        (request.resource.data.isActive == true || request.resource.data.isActive == false);
      
      allow delete: if isAdmin();
    }
    
    // NUEVA ESTRUCTURA JER√ˇRQUICA: Estudiantes
    match /superate/auth/institutions/{institutionId}/estudiantes/{estudianteId} {
      // Los estudiantes activos pueden leer su propia informaci√≥n
      allow read: if canAccess() && request.auth.uid == estudianteId;
      
      // Solo admins activos pueden leer informaci√≥n de otros estudiantes
      allow read: if isAdmin();
      
      // Los estudiantes activos pueden actualizar su propia informaci√≥n (campos limitados)
      allow update: if canAccess() && 
        request.auth.uid == estudianteId &&
        request.resource.data.role == 'student' &&
        request.resource.data.isActive == resource.data.isActive;
      
      // Solo admins activos pueden crear, actualizar o eliminar estudiantes
      allow create: if isAdmin() &&
        request.resource.data.isActive != null &&
        request.resource.data.role == 'student';
      
      allow update: if isAdmin() &&
        request.resource.data.role == 'student' &&
        (request.resource.data.isActive == true || request.resource.data.isActive == false);
      
      allow delete: if isAdmin();
    }
    
    // Colecci√≥n de instituciones
    match /superate/auth/institutions/{institutionId} {
      // Los admins pueden leer todas las instituciones (activas e inactivas)
      // Los usuarios regulares solo pueden leer instituciones activas
      allow read: if isAdmin() || 
        (canAccess() && 
         (!exists(/databases/$(database)/documents/superate/auth/institutions/$(institutionId)) ||
          get(/databases/$(database)/documents/superate/auth/institutions/$(institutionId)).data.isActive == true));
      
      // Solo admins activos pueden crear, actualizar o eliminar instituciones
      // Al crear, isActive debe estar presente
      allow create: if isAdmin() &&
        request.resource.data.isActive != null;
      
      // Los admins pueden actualizar instituciones incluso si est√°n inactivas
      // Esto permite reactivar instituciones
      allow update: if isAdmin() &&
        // Permitir cambiar isActive solo a admin
        (request.resource.data.isActive == true || request.resource.data.isActive == false);
      
      allow delete: if isAdmin();
    }
    
    // Colecci√≥n de preguntas
    match /superate/auth/questions/{questionId} {
      // Solo usuarios activos pueden leer preguntas
      allow read: if canAccess();
      
      // Solo usuarios activos con permisos pueden crear preguntas
      // Admin puede crear, otros roles se validan en sus respectivas colecciones
      allow create: if canAccess() && isAdmin();
      
      // Solo el creador o un admin activo pueden actualizar
      allow update: if canAccess() && 
        (isAdmin() || resource.data.createdBy == request.auth.uid);
      
      // Solo admins activos pueden eliminar
      allow delete: if isAdmin();
    }
    
    // Colecci√≥n de contadores
    match /superate/auth/counters/{counterId} {
      // Solo usuarios activos con permisos pueden acceder
      // Admin puede acceder, otros roles se validan en sus respectivas colecciones
      allow read, write: if canAccess() && isAdmin();
    }
    
    // Configuraci√≥n del sistema - Registro de usuarios
    match /superate/auth/system/registration {
      // Todos los usuarios (autenticados o no) pueden leer la configuraci√≥n de registro
      // Esto permite que la UI sepa si mostrar o no el bot√≥n de registro
      allow read: if true;
      
      // Solo admins activos pueden actualizar la configuraci√≥n de registro
      allow write: if isAdmin();
    }
    
    // Recursos: enlaces web y videos YouTube (misma ruta que planes de estudio)
    // WebLinks/{grado}/{materia}/{topic}/links, YoutubeLinks/{grado}/{materia}/{topic}/videos
    match /WebLinks/{grado}/{materia}/{topic}/links/{linkId} {
      allow read: if canAccess();
      allow create, update, delete: if isAdmin();
    }
    match /YoutubeLinks/{grado}/{materia}/{topic}/videos/{videoId} {
      allow read: if canAccess();
      allow create, update, delete: if isAdmin();
    }

    // Centro de Herramientas IA: AI_Tools/{toolId}
    match /AI_Tools/{toolId} {
      allow read: if canAccess();
      allow create, update, delete: if isAdmin();
    }

    // Simulacros tipo Saber 11 (ICFES): Simulacros/{simulacroId}
    match /Simulacros/{simulacroId} {
      allow read: if canAccess();
      allow create, update, delete: if isAdmin();
      // Subcolecci?n de videos explicativos (1:N)
      match /Videos/{videoId} {
        allow read: if canAccess();
        allow create, update, delete: if isAdmin();
      }
      // Materia ICFES: subcolecci?n ICFES/_/Videos (videos explicativos ICFES; doc intermedio para path impar)
      match /ICFES/{icfesDocId}/Videos/{videoId} {
        allow read: if canAccess();
        allow create, update, delete: if isAdmin();
      }
    }

    // Regla por defecto: denegar acceso a todo lo dem√°s
    match /{document=**} {
      allow read, write: if false;
    }
  }
}



